<!DOCTYPE html>
<html>

<body>
    <div id="article_list"></div>
    <button onclick="post_article()">新規投稿</button>
</body>

<head>
    <meta charset="utf-8"/>
    <script src="https://cdn.jsdelivr.net/npm/marked@3.0.7/marked.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/highlight.min.js"></script>
    <link rel="stylesheet" href="highlight/styles/github.min.css">
    <link rel="stylesheet" href="styles.css">
    <script>
        function sp_items(text){
            return text.split('@&@');
        }

        function sp_types(text){
            return text.split('@%@');
        }

        function article_show(title){
            window.location.href = `post_view.html?@&@${title}`;
        }

        function article_edit(title){
            window.location.href = `post_form.html?@&@${title}`;
        }

        function post_article(){
            window.location.href = "post_form.html";
        }

        function headline(title, author){
            return `<div class="article_label"` +
            `onclick="article_show('${title}')">${title} by ${author}</div>`+
            `<button class="edit_button" onclick="article_edit('${title}')">編集</button>`+
            `<button class="edit_button" onclick="del_article('${title}', '${author}')">投稿削除</button>`;
        }

        async function del_article(title, author){
            if (localStorage.getItem('username') != author){
                const author2 = window.prompt("ユーザー名を入力してください", "");
                if (author != author2){
                    alert("ユーザー名が誤りです");
                    return;
                }
            }
            const response = await fetch("/del_post", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ title })
            });
            let res = await response.text();
            if (res==''){
                window.location.href = 'index.html';
            }
        }


        window.onload = async (event) => {
            const response = await fetch("/get_title", { method: "GET" });
            let [titles, authors] = sp_types(await response.text());
            titles = sp_items(titles);
            authors = sp_items(authors);
            for (const i in titles){
                const add_html = headline(titles[i], authors[i]);
                document.getElementById('article_list').innerHTML += add_html;
            }
        }
    </script>
</head>

</html>